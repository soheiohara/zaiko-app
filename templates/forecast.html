{% extends "base.html" %}

{% block title %}予測ダッシュボード{% endblock %}

{% block content %}
    <h1>インタラクティブ予測カレンダー</h1>
    
    <form method="get" action="{{ url_for('forecast') }}" class="form-group">
        <label for="item_id">予測する資材を選択してください</label>
        <select name="item_id" onchange="this.form.submit()">
            {% for an_item in all_items %}
                <option value="{{ an_item.id }}" {% if an_item.id == item.id %}selected{% endif %}>
                    {{ an_item.item_name }}
                </option>
            {% endfor %}
        </select>
    </form>

    <h2 style="color: #333;">予測対象： {{ item.item_name }} （現在庫：{{ item.quantity }}）</h2>
    
    <form method="post" action="{{ url_for('forecast') }}">
        <input type="hidden" name="item_id" value="{{ item.id }}">

        <h3>消費予定数を入力してください</h3>
        <p>日ごとの発送予定数をカレンダーに入力し、「再計算」ボタンを押してください。</p>
        
        {# ▼▼▼ ここにテーブルが復活します ▼▼▼ #}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>曜日</th>
                        <th>イベント</th>
                        <th>消費予定 (手入力)</th>
                        <th>納品 (手入力)</th>
                        <th>期末在庫予測 (自動計算)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in forecast_days %}
                    {% set row_class = '' %}
                    {% if item.lower_threshold is not none and day.end_stock <= item.lower_threshold %}
                        {% set row_class = 'danger' %}
                    {% elif item.upper_threshold is not none and day.end_stock >= item.upper_threshold %}
                        {% set row_class = 'warning' %}
                    {% endif %}
                    <tr class="{{ row_class }}">
                        <td>{{ day.date_str }}</td>
                        <td>{{ day.weekday }}</td>
                        <td>
                            {% if day.delivery > 0 %}
                                <span style="color:blue;">{{ day.event }}</span>
                            {% else %}
                                {{ day.event }}
                            {% endif %}
                        </td>
                        <td><input type="number" name="consumption-{{ day.date_iso }}" value="{{ day.consumption }}" class="input-small"></td>
                        <td><input type="number" name="delivery-{{ day.date_iso }}" value="{{ day.delivery }}" class="input-small"></td>
                        <td><strong>{{ day.end_stock }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <br>
        <button type="submit" class="btn">再計算して予測を更新</button>
    </form>

    <div style="margin-top: 3em;">
        <h2>在庫推移グラフ</h2>
        <canvas id="inventoryChart"></canvas>
    </div>
{% endblock %}


{% block scripts %}
<script>
    // Pythonから渡された予測データをJavaScriptの変数に変換
    const forecastData = {{ forecast_days | tojson }};
    const itemData = {{ item.to_dict() | tojson }};

    // グラフ描画のための準備
    const labels = forecastData.map(day => day.date_str);
    const stockData = forecastData.map(day => day.end_stock);
    
    const lowerThreshold = itemData.lower_threshold;
    const upperThreshold = itemData.upper_threshold;

    // グラフを描画するキャンバスを取得
    const ctx = document.getElementById('inventoryChart').getContext('2d');

    // Chart.jsでグラフを作成
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '予測在庫数',
                    data: stockData,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                },
                {
                    label: '下限閾値',
                    data: Array(labels.length).fill(lowerThreshold),
                    borderColor: 'rgb(255, 99, 132)',
                    borderDash: [5, 5],
                    pointRadius: 0
                },
                {
                    label: '上限閾値',
                    data: Array(labels.length).fill(upperThreshold),
                    borderColor: 'rgb(54, 162, 235)',
                    borderDash: [5, 5],
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}